<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pixel Sudoku</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'VT323', monospace;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .no-select { user-select: none; -webkit-user-select: none; }
        
        .pixel-shadow { box-shadow: 4px 4px 0px 0px rgba(0,0,0,1); }
        .pixel-shadow-sm { box-shadow: 2px 2px 0px 0px rgba(0,0,0,1); }
        .pixel-shadow-active:active { transform: translate(2px, 2px); box-shadow: none; }
        .scanlines {
            background: linear-gradient(transparent 50%, rgba(0,0,0,0.1) 50%);
            background-size: 100% 4px;
        }

        /* ==========================================
           ÂÖ≥ÈîÆ‰øÆÊîπÔºö3x3 ÊâìÂç∞Â∏ÉÂ±Ä (9‰∏™/È°µ)
           ========================================== */
        @media print {
            .no-print, body > div.game-container { display: none !important; }
            
            body {
                background-color: white !important;
                padding: 0 !important;
                margin: 0 !important;
                -webkit-print-color-adjust: exact;
            }

            #print-area {
                display: grid !important;
                /* Êîπ‰∏∫ 3 Âàó */
                grid-template-columns: repeat(3, 1fr); 
                /* Êîπ‰∏∫ 3 Ë°å */
                grid-template-rows: repeat(3, 1fr);    
                /* ÂáèÂ∞èÈó¥Ë∑ù‰ª•ÈÄÇÂ∫î A4 */
                gap: 0.5cm; 
                padding: 0.5cm;
                width: 100%;
                height: 100vh;
                box-sizing: border-box;
            }

            .puzzle-wrapper {
                display: flex;
                flex-direction: column;
                align-items: center;
                /* ÈÅøÂÖçÂàÜÈ°µÊñ≠ÂºÄ */
                break-inside: avoid; 
                page-break-inside: avoid;
            }

            .puzzle-title {
                font-size: 12pt; /* Áº©Â∞èÊ†áÈ¢ò */
                font-weight: bold;
                margin-bottom: 2px;
                font-family: sans-serif; /* ÊâìÂç∞Êó∂Áî®Êó†Ë°¨Á∫ø‰ΩìÊõ¥Ê∏ÖÊô∞ */
            }

            .print-grid {
                border: 2px solid #000;
                display: grid;
                grid-template-columns: repeat(9, 1fr);
                width: 100%;
                /* ÈôêÂà∂ÊúÄÂ§ßÂÆΩÂ∫¶ÔºåÈò≤Ê≠¢Êãâ‰º∏ÂèòÂΩ¢ */
                max-width: 5.5cm; 
            }

            .print-cell {
                border: 1px solid #666; /* ÁªÜÁ∫ø */
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px; /* Áº©Â∞èÂ≠ó‰Ωì */
                height: 22px;    /* Áº©Â∞èÈ´òÂ∫¶‰ª•ÂÆπÁ∫≥9‰∏™ */
                color: black;
                background: white;
            }

            /* Âä†Á≤óÂÆ´Ê†ºÁ∫ø */
            .print-cell:nth-child(3n) { border-right: 2px solid #000; }
            .print-cell:nth-child(9n) { border-right: 1px solid #666; }
            .print-row-border { border-bottom: 2px solid #000; }
        }
    </style>
</head>
<body class="bg-zinc-200 min-h-screen flex flex-col items-center justify-center p-2 sm:p-4 text-gray-900 no-select">

    <!-- Ê∏∏ÊàèÂÆπÂô® -->
    <div class="game-container w-full max-w-lg bg-gray-300 p-3 sm:p-5 rounded-xl border-4 border-gray-800 pixel-shadow relative">
        
        <!-- È°∂ÈÉ® LCD -->
        <div class="bg-[#9bbc0f] border-4 border-gray-700 p-3 mb-4 rounded shadow-inner flex justify-between items-end relative overflow-hidden">
            <div class="absolute inset-0 pointer-events-none scanlines"></div>
            <div class="relative z-10">
                <div class="text-xs sm:text-sm font-bold opacity-70">DIFFICULTY</div>
                <div id="display-diff" class="text-xl sm:text-2xl leading-none">EASY</div>
            </div>
            <div class="relative z-10 flex flex-col items-end">
                <div class="text-xs sm:text-sm font-bold opacity-70">MISTAKES</div>
                <div id="display-mistakes" class="text-xl sm:text-2xl leading-none">0/3</div>
            </div>
            <div class="relative z-10 flex flex-col items-end">
                <div class="text-xs sm:text-sm font-bold opacity-70">TIME</div>
                <div id="display-time" class="text-xl sm:text-2xl leading-none font-mono">00:00</div>
            </div>
        </div>

        <!-- ÈöæÂ∫¶ÈÄâÊã© -->
        <div class="flex gap-2 mb-4 justify-center" id="difficulty-controls">
            <button onclick="startGame('Easy')" class="diff-btn px-3 py-1 border-2 border-black text-lg pixel-shadow-sm pixel-shadow-active bg-blue-500 text-white transition-colors">Easy</button>
            <button onclick="startGame('Medium')" class="diff-btn px-3 py-1 border-2 border-black text-lg pixel-shadow-sm pixel-shadow-active bg-white text-black transition-colors">Medium</button>
            <button onclick="startGame('Hard')" class="diff-btn px-3 py-1 border-2 border-black text-lg pixel-shadow-sm pixel-shadow-active bg-white text-black transition-colors">Hard</button>
        </div>

        <!-- Ê£ãÁõò -->
        <div class="relative bg-gray-800 p-2 rounded pixel-shadow mb-4">
            <div id="win-overlay" class="hidden absolute inset-0 z-20 flex items-center justify-center bg-black bg-opacity-80 rounded flex-col">
                <h2 class="text-6xl text-yellow-400 mb-2 drop-shadow-[4px_4px_0_#f00] animate-bounce">WIN!</h2>
                <button onclick="startGame(state.difficulty)" class="mt-4 px-6 py-2 bg-green-500 text-white border-4 border-white text-2xl hover:bg-green-400">RESTART</button>
            </div>
            <div id="sudoku-board" class="bg-white border-4 border-gray-800 grid grid-cols-9 grid-rows-9 aspect-square w-full"></div>
        </div>

        <!-- ÊåâÈíÆÁªÑ -->
        <div class="flex gap-2 mb-3">
            <button id="btn-note" onclick="toggleNoteMode()" class="flex-1 py-3 border-2 border-black font-bold text-xl pixel-shadow-sm pixel-shadow-active bg-gray-200 text-gray-600 flex items-center justify-center gap-2">
                <span>‚úé</span> <span id="note-text">NOTES</span>
            </button>
            <button onclick="handleInput(0)" class="flex-1 py-3 bg-red-200 border-2 border-black font-bold text-xl pixel-shadow-sm pixel-shadow-active text-red-800 flex items-center justify-center gap-2">
                <span>‚å´</span> ERASE
            </button>
            <!-- ÊâìÂç∞ÊåâÈíÆ -->
            <button onclick="handlePrint()" class="flex-1 py-3 bg-white border-2 border-black font-bold text-xl pixel-shadow-sm pixel-shadow-active text-black flex items-center justify-center gap-2" title="Print 9 Puzzles (A4)">
                <span>üñ®Ô∏è</span> PRINT 9
            </button>
        </div>

        <!-- ÈîÆÁõò -->
        <div class="grid grid-cols-5 sm:grid-cols-9 gap-2">
            <div id="numpad-container" class="contents"></div>
        </div>
        
        <div class="mt-4 text-center text-gray-500 text-sm">
            ËÄÅÂπ¥Áó¥ÂëÜ‰ªéÂ®ÉÂ®ÉÊäìËµ∑ By KK
        </div>
    </div>

    <!-- ÊâìÂç∞Âå∫Âüü -->
    <div id="print-area" class="hidden"></div>

    <script>
        // ==========================================
        // 1. Audio Engine
        // ==========================================
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        function initAudio() { if (!audioCtx) audioCtx = new AudioContext(); if (audioCtx.state === 'suspended') audioCtx.resume(); }
        function playSound(type) {
            if (!audioCtx) initAudio();
            try {
                const osc = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                osc.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                const now = audioCtx.currentTime;
                
                if(type === 'tap') { osc.type='square'; osc.frequency.setValueAtTime(600,now); gainNode.gain.setValueAtTime(0.05,now); gainNode.gain.exponentialRampToValueAtTime(0.001,now+0.05); osc.start(now); osc.stop(now+0.05); }
                else if(type === 'input') { osc.type='triangle'; osc.frequency.setValueAtTime(440,now); osc.frequency.linearRampToValueAtTime(880,now+0.1); gainNode.gain.setValueAtTime(0.1,now); gainNode.gain.linearRampToValueAtTime(0.01,now+0.1); osc.start(now); osc.stop(now+0.1); }
                else if(type === 'note') { osc.type='sine'; osc.frequency.setValueAtTime(1200,now); gainNode.gain.setValueAtTime(0.05,now); gainNode.gain.exponentialRampToValueAtTime(0.001,now+0.05); osc.start(now); osc.stop(now+0.05); }
                else if(type === 'error') { osc.type='sawtooth'; osc.frequency.setValueAtTime(150,now); osc.frequency.linearRampToValueAtTime(100,now+0.3); gainNode.gain.setValueAtTime(0.2,now); gainNode.gain.linearRampToValueAtTime(0.01,now+0.3); osc.start(now); osc.stop(now+0.3); }
                else if(type === 'win') { /* melody omitted for brevity */ }
            } catch(e) {}
        }

        // ==========================================
        // 2. Sudoku Logic
        // ==========================================
        const BLANK = 0;
        function isValid(board, row, col, num) {
            for (let i = 0; i < 9; i++) {
                if (board[row * 9 + i] === num && i !== col) return false;
                if (board[i * 9 + col] === num && i !== row) return false;
                const boxRow = 3 * Math.floor(row / 3) + Math.floor(i / 3);
                const boxCol = 3 * Math.floor(col / 3) + i % 3;
                if (board[boxRow * 9 + boxCol] === num && (boxRow !== row || boxCol !== col)) return false;
            }
            return true;
        }
        function solveSudoku(board) {
            for (let i = 0; i < 81; i++) {
                if (board[i] === BLANK) {
                    for (let num = 1; num <= 9; num++) {
                        if (isValid(board, Math.floor(i/9), i%9, num)) {
                            board[i] = num;
                            if (solveSudoku(board)) return true;
                            board[i] = BLANK;
                        }
                    }
                    return false;
                }
            }
            return true;
        }
        function generateData(difficulty) {
            const solution = Array(81).fill(BLANK);
            const firstRow = [1,2,3,4,5,6,7,8,9].sort(() => Math.random() - 0.5);
            for(let i=0; i<9; i++) solution[i] = firstRow[i];
            solveSudoku(solution);
            const puzzle = [...solution];
            let attempts = difficulty === 'Easy' ? 30 : difficulty === 'Medium' ? 45 : 56;
            while (attempts > 0) {
                let idx = Math.floor(Math.random() * 81);
                if (puzzle[idx] !== BLANK) { puzzle[idx] = BLANK; attempts--; }
            }
            return { puzzle, solution };
        }

        // ==========================================
        // 3. App Logic
        // ==========================================
        const state = {
            board: [], initialBoard: [], solution: [], notes: Array(81).fill(null).map(() => []),
            difficulty: 'Easy', selectedIdx: null, isNoteMode: false, mistakes: 0, timer: 0, timerId: null, isWon: false, isGameActive: false
        };

        const els = {
            board: document.getElementById('sudoku-board'),
            diffDisplay: document.getElementById('display-diff'),
            mistakesDisplay: document.getElementById('display-mistakes'),
            timeDisplay: document.getElementById('display-time'),
            winOverlay: document.getElementById('win-overlay'),
            noteBtn: document.getElementById('btn-note'),
            noteText: document.getElementById('note-text'),
            numpad: document.getElementById('numpad-container'),
            printArea: document.getElementById('print-area')
        };

        for (let i = 1; i <= 9; i++) {
            const btn = document.createElement('button');
            btn.className = "bg-blue-100 border-2 border-black text-3xl font-bold py-3 rounded pixel-shadow-sm pixel-shadow-active text-blue-900 active:bg-blue-300 transition-colors";
            btn.textContent = i;
            btn.onclick = () => handleInput(i);
            els.numpad.appendChild(btn);
        }

        function startGame(diff) {
            initAudio();
            const { puzzle, solution } = generateData(diff);
            state.board = [...puzzle]; state.initialBoard = [...puzzle]; state.solution = [...solution];
            state.notes = Array(81).fill(null).map(() => []);
            state.difficulty = diff; state.selectedIdx = null; state.mistakes = 0; state.timer = 0; state.isWon = false; state.isGameActive = true;
            if (state.timerId) clearInterval(state.timerId);
            state.timerId = setInterval(() => { if (state.isGameActive && !state.isWon) { state.timer++; updateHeader(); } }, 1000);
            els.winOverlay.classList.add('hidden');
            updateDifficultyUI(diff);
            playSound('tap');
            renderBoard();
            updateHeader();
        }

        // ==========================================
        // 4. PRINT LOGIC (9 Puzzles)
        // ==========================================
        function handlePrint() {
            playSound('tap');
            els.printArea.innerHTML = ''; 

            // Âæ™ÁéØÁîüÊàê 9 ‰∏™Êï∞Áã¨
            for(let i=0; i<9; i++) {
                const { puzzle } = generateData(state.difficulty);
                const wrapper = document.createElement('div');
                wrapper.className = 'puzzle-wrapper'; // ‰ΩøÁî®Êñ∞Ê†∑Âºè
                
                // ÁÆÄÂåñÊ†áÈ¢òÔºåËäÇÁúÅÁ©∫Èó¥
                const title = document.createElement('div');
                title.className = 'puzzle-title';
                title.innerText = `#${i+1} ${state.difficulty}`;
                wrapper.appendChild(title);

                const grid = document.createElement('div');
                grid.className = 'print-grid';
                
                puzzle.forEach((val, idx) => {
                    const cell = document.createElement('div');
                    // Â∫ïÈÉ®ËæπÊ°ÜÈÄªËæë
                    const row = Math.floor(idx / 9);
                    const borderClass = ((row + 1) % 3 === 0 && row !== 8) ? 'print-row-border' : '';
                    
                    cell.className = `print-cell ${borderClass}`;
                    cell.innerText = val === BLANK ? '' : val;
                    grid.appendChild(cell);
                });

                wrapper.appendChild(grid);
                els.printArea.appendChild(wrapper);
            }

            setTimeout(() => { window.print(); }, 100);
        }

        // UI Updates & Interactions
        function toggleNoteMode() { state.isNoteMode = !state.isNoteMode; renderNoteBtn(); playSound('tap'); }
        function renderNoteBtn() { 
            if(state.isNoteMode) { els.noteBtn.className = els.noteBtn.className.replace('bg-gray-200 text-gray-600', 'bg-yellow-400 text-black'); els.noteText.innerText='ON'; }
            else { els.noteBtn.className = els.noteBtn.className.replace('bg-yellow-400 text-black', 'bg-gray-200 text-gray-600'); els.noteText.innerText='NOTES'; }
        }
        function handleCellClick(idx) { if(!state.isGameActive) return; state.selectedIdx = idx; initAudio(); playSound('tap'); renderBoard(); }
        function handleInput(num) {
            if (!state.isGameActive || state.selectedIdx === null) return;
            const idx = state.selectedIdx;
            if (state.initialBoard[idx] !== BLANK) return;
            if (num === 0) { state.board[idx] = BLANK; state.notes[idx] = []; playSound('input'); renderBoard(); return; }
            if (state.isNoteMode) {
                const nIdx = state.notes[idx].indexOf(num);
                if (nIdx > -1) state.notes[idx].splice(nIdx, 1); else state.notes[idx].push(num);
                playSound('note');
            } else {
                if (num !== state.solution[idx]) { state.mistakes++; playSound('error'); state.board[idx] = num; updateHeader(); }
                else { state.board[idx] = num; state.notes[idx] = []; playSound('input'); checkWin(); }
            }
            renderBoard();
        }
        function checkWin() { if (state.board.every(n => n !== BLANK) && state.board.every((n, i) => n === state.solution[i])) { state.isWon = true; state.isGameActive = false; clearInterval(state.timerId); els.winOverlay.classList.remove('hidden'); playSound('win'); } }
        function formatTime(s) { const m = Math.floor(s/60).toString().padStart(2,'0'); const sec = (s%60).toString().padStart(2,'0'); return `${m}:${sec}`; }
        function updateHeader() { els.diffDisplay.innerText = state.difficulty.toUpperCase(); els.mistakesDisplay.innerText = `${state.mistakes}/3`; els.timeDisplay.innerText = formatTime(state.timer); }
        function updateDifficultyUI(d) { document.querySelectorAll('.diff-btn').forEach(b => { b.innerText===d ? b.classList.add('bg-blue-500','text-white') : b.classList.remove('bg-blue-500','text-white'); b.innerText!==d && b.classList.add('bg-white','text-black'); }); }
        
        function renderBoard() {
            els.board.innerHTML = '';
            const selectedVal = state.selectedIdx !== null ? state.board[state.selectedIdx] : null;
            state.board.forEach((val, i) => {
                const isInit = state.initialBoard[i] !== BLANK;
                const isSel = state.selectedIdx === i;
                const isErr = !isInit && val !== BLANK && val !== state.solution[i];
                const isSame = val !== BLANK && val === selectedVal;
                const row = Math.floor(i/9), col = i%9;
                const br = (col+1)%3===0 && col!==8 ? 'border-r-4 border-gray-800' : 'border-r border-gray-400';
                const bb = (row+1)%3===0 && row!==8 ? 'border-b-4 border-gray-800' : 'border-b border-gray-400';
                let bg = isSel ? 'bg-yellow-300' : isErr ? 'bg-red-200' : isSame ? 'bg-blue-200' : 'bg-[#f0f0f0]';
                const div = document.createElement('div');
                div.className = `relative flex items-center justify-center cursor-pointer ${br} ${bb} ${bg} w-full h-full active:bg-yellow-200`;
                div.onclick = () => handleCellClick(i);
                if (val !== BLANK) {
                    div.innerHTML = `<span class="text-2xl sm:text-4xl ${isInit?'text-gray-900':isErr?'text-red-600':'text-blue-700'}">${val}</span>`;
                } else if (state.notes[i].length) {
                    let h = '<div class="grid grid-cols-3 grid-rows-3 w-full h-full p-[1px] pointer-events-none">';
                    for(let n=1; n<=9; n++) h+=`<div class="flex items-center justify-center text-[8px] sm:text-[10px] text-gray-500 font-bold">${state.notes[i].includes(n)?n:''}</div>`;
                    h+='</div>';
                    div.innerHTML = h;
                }
                els.board.appendChild(div);
            });
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.key >= '1' && e.key <= '9') handleInput(parseInt(e.key));
            if (e.key === 'Backspace' || e.key === 'Delete') handleInput(0);
            if (e.key.toLowerCase() === 'n') toggleNoteMode();
        });

        startGame('Easy');
    </script>
</body>
</html>


